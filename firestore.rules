/**
 * @file Firestore Security Rules
 * @description This ruleset enforces a strict user-ownership model for user profiles and public read access for all other collections.
 *
 * Data Structure:
 * - User profiles are stored under `/users/{userId}/userProfile`, ensuring only the user can access their profile.
 * - All other collections (roles, teamMembers, companies, shows, interactions, events, expenses, meetingMinutes, tasks, todoItems) are stored at the top level.
 *
 * Key Security Decisions:
 * - User profiles are private and only accessible to the owning user.
 * - All other data is considered public and accessible to all users.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Enforces document ownership for user profiles, ensuring only the owner can read and write.
     * @path /users/{userId}/userProfile
     * @allow (create) - User with ID 'user123' creates their profile at /users/user123/userProfile
     * @allow (get, update, delete) - User with ID 'user123' reads/updates/deletes their profile at /users/user123/userProfile
     * @deny (create, update, delete) - User with ID 'user456' attempts to modify profile at /users/user123/userProfile
     * @deny (list) - Prevents listing of user profiles.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/userProfile {
      //function isOwner(userId) {
       // return request.auth.uid == userId;
     // }
      function isOwner(userId) {
        return request.auth.uid == userId;
      }
      function isExistingOwner(userId) {
          return isOwner(userId) && resource != null;
        }

      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId) ;
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Allows public read and write access to the teamMembers collection for development.
     * @path /teamMembers/{memberId}
     * @allow (get, list, create, update, delete) - Any user can manage team members.
     * @principle Allows full access for development purposes.
     */
    match /teamMembers/{memberId} {
        allow read, write: if true;
    }

    /**
     * @description Allows public write access to the shows collection for the external form, and full access for authenticated users.
     * @path /shows/{showId}
     * @allow (create) - Any user (including anonymous) can create a new show.
     * @allow (read, update, delete) - Only authenticated users can manage shows.
     * @principle Allows public creation for submissions and restricted management.
     */
    match /shows/{showId} {
        allow create: if true;
        allow read, update, delete: if request.auth != null;
    }

    /**
     * @description Allows public read access to roles and restricts writes.
     * @path /roles/{roleId}
     * @allow (get, list) - Any user can read role data.
     * @deny (create, update, delete) - No one can create, update, or delete roles.
     * @principle Allows public read access and restricts writes to no one.
     */
    match /roles/{roleId} {
        allow get, list: if true;
        allow create, update, delete: if false;
    }

    /**
     * @description Allows public write access to the companies collection for the external form, and full access for authenticated users.
     * @path /companies/{companyId}
     * @allow (create) - Any user (including anonymous) can create a new company.
     * @allow (read, update, delete) - Only authenticated users can manage companies.
     * @principle Allows public creation for submissions and restricted management.
     */
    match /companies/{companyId} {
        allow create: if true;
        allow read, update, delete: if request.auth != null;
    }

    /**
     * @description Allows public read access to interactions and restricts writes.
     * @path /shows/{showId}/interactions/{interactionId}
     * @allow (get, list) - Any user can read interactions data.
     * @deny (create, update, delete) - No one can create, update, or delete interactions.
     * @principle Allows public read access and restricts writes to no one.
     */
    match /shows/{showId}/interactions/{interactionId} {
        allow get, list: if true;
        allow create, update, delete: if false;
    }

    /**
     * @description Allows authenticated users to read and write events.
     * @path /events/{eventId}
     * @allow (get, list, create, update, delete) - Any authenticated user can manage events.
     * @principle Restricts calendar access to logged-in users.
     */
    match /events/{eventId} {
        allow get, list: if request.auth != null;
        allow create, update, delete: if request.auth != null;
    }

    /**
     * @description Allows public read access to expenses and restricts writes.
     * @path /expenses/{expenseId}
     * @allow (get, list) - Any user can read expenses data.
     * @deny (create, update, delete) - No one can create, update, or delete expenses.
     * @principle Allows public read access and restricts writes to no one.
     */
    match /expenses/{expenseId} {
        allow get, list: if true;
        allow create, update, delete: if false;
    }

    /**
     * @description Allows public read access to meetingMinutes and restricts writes.
     * @path /meetingMinutes/{meetingMinutesId}
     * @allow (get, list) - Any user can read meetingMinutes data.
     * @deny (create, update, delete) - No one can create, update, or delete meetingMinutes.
     * @principle Allows public read access and restricts writes to no one.
     */
    match /meetingMinutes/{meetingMinutesId} {
        allow get, list: if true;
        allow create, update, delete: if false;
    }

    /**
     * @description Allows authenticated users to read and write tasks.
     * @path /tasks/{taskId}
     * @allow (read, write) - Authenticated users can manage tasks.
     * @principle Restricts task management to logged-in users.
     */
    match /tasks/{taskId} {
        allow read, write: if request.auth != null;
    }

    /**
     * @description Allows public read access to todoItems and restricts writes.
     * @path /todoItems/{todoItemId}
     * @allow (get, list) - Any user can read todoItems data.
     * @deny (create, update, delete) - No one can create, update, or delete todoItems.
     * @principle Allows public read access and restricts writes to no one.
     */
    match /todoItems/{todoItemId} {
        allow get, list: if true;
        allow create, update, delete: if false;
    }
  }
}
