/**
 * @fileoverview Firestore Security Rules for laSalapp.
 *
 * Core Philosophy:
 * This ruleset enforces a combination of ownership-based access control,
 * role-based access control (for admins), and shared access via membership maps.
 * It prioritizes security and data integrity while allowing for flexible data shapes during prototyping.
 *
 * Data Structure:
 * - User profiles are stored under `/user_profiles/{userProfileId}`.
 * - Team member data is stored under `/team_members/{teamMemberId}`.
 * - Expenses and responsibilities are nested under their respective team members.
 * - Events, Programming, MeetingMinutes, TodoItems, Ideas, and Productions are top-level collections.
 * - Admin privileges are determined by the existence of a document in `/roles_admin/{userId}`.
 *
 * Key Security Decisions:
 * - Listing of user profiles and team members is restricted to admins.
 * - Expenses and responsibilities are only accessible to the associated team member and admins.
 * - Productions utilize a `members` map for shared access control.
 * - Admin privileges are granted based on document existence in `/roles_admin/{userId}`.
 * - Read operations for events are public for the prototyping stage.
 *
 * Denormalization for Authorization:
 * - Productions use a `members` map to store user roles directly on the document,
 *   avoiding the need for `get()` calls to determine access.
 *
 * Structural Segregation:
 * - User-specific data (expenses, responsibilities) is stored under team members,
 *   while public or shared data (events, productions) is stored in top-level collections.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the current user is signed in.
     * @path N/A (Helper Function)
     * @allow N/A (Helper Function)
     * @deny N/A (Helper Function)
     * @principle N/A (Helper Function)
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the current user is the owner of the resource based on the provided userId.
     * @path N/A (Helper Function)
     * @allow N/A (Helper Function)
     * @deny N/A (Helper Function)
     * @principle Enforces ownership-based access control.
     */
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    /**
     * @description Checks if the current user is the owner of the resource based on the provided userId and if the resource exists.
     * @path N/A (Helper Function)
     * @allow N/A (Helper Function)
     * @deny N/A (Helper Function)
     * @principle Enforces existence check before destructive operations.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * @description Checks if the current user has admin privileges based on document existence in /roles_admin/{uid}.
     * @path N/A (Helper Function)
     * @allow N/A (Helper Function)
     * @deny N/A (Helper Function)
     * @principle Implements Database-Based Access Control (DBAC) for admin roles.
     */
    function isAdmin() {
      return exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }

   /**
     * @description User profile information. Accessible to the user and administrators.
     * @path /user_profiles/{userProfileId}
     * @allow (create) User with ID 'user123' creates their own profile.
     * @allow (update) User with ID 'user123' updates their own profile.
     * @allow (get) User with ID 'user123' gets their own profile.
     * @allow (delete) Admin deletes user profile.
     * @deny (create) User with ID 'user123' tries to create profile for 'user456'.
     * @deny (update) User with ID 'user123' tries to update profile for 'user456'.
     * @principle Enforces document ownership for writes and admin access.
     */
    match /user_profiles/{userProfileId} {
      allow get: if isOwner(userProfileId) || isAdmin();
      allow list: if isAdmin();
      allow create: if isOwner(userProfileId) && request.resource.data.id == userProfileId;
      allow update: if isExistingOwner(userProfileId) && request.resource.data.id == resource.data.id || isAdmin();
      allow delete: if isAdmin() && resource != null;
    }

    /**
     * @description Team member information. Accessible to the team member and administrators.
     * @path /team_members/{teamMemberId}
     * @allow (create) Admin creates a team member.
     * @allow (update) Admin updates a team member.
     * @allow (get) Team member with ID 'team123' gets their own profile.
     * @allow (delete) Admin deletes a team member.
     * @deny (create) User with ID 'user123' tries to create a team member.
     * @deny (update) User with ID 'user123' tries to update a team member.
     * @principle Enforces document ownership for reads and admin access for writes.
     */
    match /team_members/{teamMemberId} {
      allow get: if isAdmin();
      allow list: if isAdmin();
      allow create: if isAdmin();
      allow update: if isAdmin() && resource != null;
      allow delete: if isAdmin() && resource != null;
    }

    /**
     * @description Programming event information. Accessible to authorized personnel.
     * @path /programming/{programmingId}
     * @allow (get) Any signed-in user gets a programming event.
     * @allow (create) Admin creates a programming event.
     * @allow (update) Admin updates a programming event.
     * @allow (delete) Admin deletes a programming event.
     * @deny (create) Non-admin user tries to create a programming event.
     * @deny (update) Non-admin user tries to update a programming event.
     * @principle Enforces admin-only writes and public reads.
     */
    match /programming/{programmingId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isAdmin();
      allow update: if isAdmin() && resource != null;
      allow delete: if isAdmin() && resource != null;
    }

    /**
     * @description Event schedule information. Accessible to authorized personnel.
     * @path /events/{eventId}
     * @allow (get) Any signed-in user gets an event.
     * @allow (list) Any signed-in user lists events.
     * @allow (create) Admin creates an event.
     * @allow (update) Admin updates an event.
     * @allow (delete) Admin deletes an event.
     * @deny (create) Non-admin user tries to create an event.
     * @deny (update) Non-admin user tries to update an event.
     * @principle Enforces admin-only writes and public reads.
     */
    match /events/{eventId} {
      allow get: if true;
      allow list: if true;
      allow create: if isAdmin();
      allow update: if isAdmin() && resource != null;
      allow delete: if isAdmin() && resource != null;
    }

    /**
     * @description Expense information for each team member. Accessible to the team member and administrators.
     * @path /team_members/{teamMemberId}/expenses/{expenseId}
     * @allow (get) Team member with ID 'team123' gets their own expense.
     * @allow (create) Team member with ID 'team123' creates an expense for themselves.
     * @allow (update) Team member with ID 'team123' updates their own expense.
     * @allow (delete) Team member with ID 'team123' deletes their own expense.
     * @deny (create) Team member with ID 'team123' tries to create an expense for 'team456'.
     * @deny (update) Team member with ID 'team123' tries to update an expense for 'team456'.
     * @principle Enforces document ownership for writes and admin access.
     */
    match /team_members/{teamMemberId}/expenses/{expenseId} {
      allow get: if isOwner(teamMemberId) || isAdmin();
      allow list: if isOwner(teamMemberId) || isAdmin();
      allow create: if isOwner(teamMemberId) && request.resource.data.teamMemberId == teamMemberId;
      allow update: if isExistingOwner(teamMemberId) && request.resource.data.teamMemberId == resource.data.teamMemberId || isAdmin();
      allow delete: if isExistingOwner(teamMemberId) || isAdmin();
    }

    /**
     * @description Meeting minutes. Accessible to authorized personnel.
     * @path /meeting_minutes/{meetingMinutesId}
     * @allow (get) Any signed-in user gets meeting minutes.
     * @allow (create) Admin creates meeting minutes.
     * @allow (update) Admin updates meeting minutes.
     * @allow (delete) Admin deletes meeting minutes.
     * @deny (create) Non-admin user tries to create meeting minutes.
     * @deny (update) Non-admin user tries to update meeting minutes.
     * @principle Enforces admin-only writes and public reads.
     */
    match /meeting_minutes/{meetingMinutesId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isAdmin();
      allow update: if isAdmin() && resource != null;
      allow delete: if isAdmin() && resource != null;
    }

    /**
     * @description Responsibility assignments for team members. Accessible to the team member and administrators.
     * @path /team_members/{teamMemberId}/responsibilities/{responsibilityId}
     * @allow (get) Team member with ID 'team123' gets their own responsibility.
     * @allow (create) Team member with ID 'team123' creates a responsibility for themselves.
     * @allow (update) Team member with ID 'team123' updates their own responsibility.
     * @allow (delete) Team member with ID 'team123' deletes their own responsibility.
     * @deny (create) Team member with ID 'team123' tries to create a responsibility for 'team456'.
     * @deny (update) Team member with ID 'team123' tries to update a responsibility for 'team456'.
     * @principle Enforces document ownership for writes and admin access.
     */
    match /team_members/{teamMemberId}/responsibilities/{responsibilityId} {
      allow get: if isOwner(teamMemberId) || isAdmin();
      allow list: if isOwner(teamMemberId) || isAdmin();
      allow create: if isOwner(teamMemberId) && request.resource.data.teamMemberId == teamMemberId;
      allow update: if isExistingOwner(teamMemberId) && request.resource.data.teamMemberId == resource.data.teamMemberId || isAdmin();
      allow delete: if isExistingOwner(teamMemberId) || isAdmin();
    }

    /**
     * @description General to-do list items. Accessible to authorized personnel.
     * @path /todo_items/{todoItemId}
     * @allow (get) Any signed-in user gets a to-do item.
     * @allow (create) Admin creates a to-do item.
     * @allow (update) Admin updates a to-do item.
     * @allow (delete) Admin deletes a to-do item.
     * @deny (create) Non-admin user tries to create a to-do item.
     * @deny (update) Non-admin user tries to update a to-do item.
     * @principle Enforces admin-only writes and public reads.
     */
    match /todo_items/{todoItemId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isAdmin();
      allow update: if isAdmin() && resource != null;
      allow delete: if isAdmin() && resource != null;
    }

    /**
     * @description In-house production information. Includes denormalized 'members' map for authorization independence.
     * @path /productions/{productionId}
     * @allow (get) User with ID 'user123' gets a production they are a member of with role 'editor'.
     * @allow (create) Admin creates a production.
     * @allow (update) User with ID 'user123' updates a production they are a member of with role 'editor'.
     * @allow (delete) Admin deletes a production.
     * @deny (create) Non-admin user tries to create a production.
     * @deny (update) User with ID 'user123' tries to update a production they are not a member of.
     * @principle Enforces shared access via a membership map and admin access.
     */
    match /productions/{productionId} {
        allow get: if isSignedIn() && resource.data.members[request.auth.uid] != null;
        allow list: if isSignedIn();
        allow create: if isAdmin();
        allow update: if isSignedIn() && resource.data.members[request.auth.uid] != null  && resource != null || isAdmin();
        allow delete: if isAdmin() && resource != null;
    }

    /**
     * @description Brainstormed ideas. Accessible to authorized personnel.
     * @path /ideas/{ideaId}
     * @allow (get) Any signed-in user gets an idea.
     * @allow (create) Admin creates an idea.
     * @allow (update) Admin updates an idea.
     * @allow (delete) Admin deletes an idea.
     * @deny (create) Non-admin user tries to create an idea.
     * @deny (update) Non-admin user tries to update an idea.
     * @principle Enforces admin-only writes and public reads.
     */
    match /ideas/{ideaId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isAdmin();
      allow update: if isAdmin() && resource != null;
      allow delete: if isAdmin() && resource != null;
    }

    /**
     * @description Indicates administrator privileges. Existence of document grants admin access.
     * @path /roles_admin/{userId}
     */
    match /roles_admin/{userId} {
        allow get: if isAdmin();
        allow list: if false;
        allow create: if isAdmin();
        allow update: if false;
        allow delete: if isAdmin() && resource != null;
    }
  }
}